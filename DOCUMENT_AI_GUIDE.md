# Document AI 高精度OCRガイド

## 問題: Invoice Parserで日本語が文字化け

Invoice Parserは英語に最適化されているため、日本語の注文票では精度が低い場合があります。

## 解決策

特定フォーマットの注文票から高精度でデータを抽出するには、以下の方法を推奨します。

---

## 方法1: Custom Document Extractor（最推奨）

独自の注文票フォーマットに対してカスタムトレーニングを行う方法です。

### メリット
- ✅ **日本語完全対応**
- ✅ **独自フォーマットに最適化**（複数種類の注文票に対応可能）
- ✅ **高精度**（95%以上の認識精度）
- ✅ **独自フィールド定義**（得意先名、日付、品名、数量、金額など自由に設定）
- ✅ **表形式データの抽出**（明細行を構造化して取得）

### 設定手順

#### 1. プロセッサーの作成
1. [Google Cloud Console](https://console.cloud.google.com/ai/document-ai) にアクセス
2. **「プロセッサーを作成」**をクリック
3. **「Custom Document Extractor」**を選択
4. プロセッサー名を入力（例: `order-form-extractor`）
5. リージョンを選択（`us`または`asia-northeast1`）
6. **「作成」**をクリック

#### 2. スキーマの定義
1. プロセッサーの詳細ページで**「スキーマ」**タブをクリック
2. **「フィールドを追加」**で抽出したいフィールドを定義：

**推奨フィールド:**
- `customer_name` (顧客名)
- `order_date` (注文日)
- `order_number` (注文番号)
- `total_amount` (合計金額)
- `tax_amount` (消費税額)
- `items` (明細 - テーブル型)
  - `item_name` (品名)
  - `quantity` (数量)
  - `unit_price` (単価)
  - `amount` (金額)

#### 3. トレーニングデータの準備
1. **「トレーニング」**タブをクリック
2. サンプル注文票をアップロード（**20-50枚推奨**）
3. 各ドキュメントで定義したフィールドをラベリング：
   - フィールドをクリック
   - ドキュメント内の対応する箇所を選択
   - 表形式データは行ごとにラベリング

#### 4. トレーニングの実行
1. すべてのドキュメントのラベリングが完了したら**「トレーニング」**をクリック
2. トレーニングには通常1-2時間かかります

#### 5. .env.localの更新
トレーニング完了後、新しいプロセッサーIDを設定：
```env
GOOGLE_CLOUD_PROCESSOR_ID=your-new-custom-processor-id
```

### 料金
- トレーニング: 無料（最初の1,000ページ/月）
- 処理: $1.50/1,000ページ（Invoice Parserより高額）

---

## 方法2: Form Parser（汎用フォーム）

フォーマットが一定で、複雑なトレーニングが不要な場合に使用します。

### メリット
- ✅ 日本語対応
- ✅ カスタムトレーニング不要
- ✅ 表形式データに強い
- ✅ 低コスト（$0.65/1,000ページ）

### 設定手順
1. [Google Cloud Console](https://console.cloud.google.com/ai/document-ai) にアクセス
2. **「プロセッサーを作成」**
3. **「Form Parser」**を選択
4. プロセッサーIDを`.env.local`に設定

### 注意点
- キー・バリューペアの自動抽出（フィールド名の指定不可）
- 精度はCustom Extractorより低い（80-90%程度）

---

## 方法3: Document OCR + 後処理

最もシンプルな方法ですが、後処理が必要です。

### メリット
- ✅ セットアップ簡単
- ✅ 日本語完全対応
- ✅ 低コスト（$0.10/1,000ページ）

### 設定手順
1. **「Document OCR」**プロセッサーを作成
2. テキスト全体を抽出
3. 正規表現やAIで必要な情報を抽出

### デメリット
- 構造化されていない
- 後処理のコードが必要
- 精度が低い

---

## 推奨フロー

### ステップ1: まずForm Parserで試す
費用対効果が良く、セットアップが簡単です。

### ステップ2: 精度が不十分ならCustom Extractorへ
20-50枚のサンプルをラベリングして高精度モデルを構築。

### ステップ3: 定期的に再トレーニング
新しい注文票フォーマットが追加されたら、サンプルを追加してトレーニング。

---

## 現在の実装での対応

このアプリケーションは、すでに以下に対応しています：

- ✅ **フォームフィールド抽出**（Form Parser用）
- ✅ **テーブル抽出**（明細行の取得）
- ✅ **エンティティ抽出**（Invoice Parser用）
- ✅ **生テキスト表示**

プロセッサーを変更するだけで、すぐに他のプロセッサータイプを試せます。

---

## 参考リンク

- [Document AI Custom Extractor](https://cloud.google.com/document-ai/docs/custom-classifier)
- [Document AI Form Parser](https://cloud.google.com/document-ai/docs/processors-list#processor_form-parser)
- [Document AI 料金](https://cloud.google.com/document-ai/pricing)
